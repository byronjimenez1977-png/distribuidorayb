<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Distribuidora A & B</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<meta name="theme-color" content="#007bff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dist. A&B">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{--azul1:#007bff;--azul2:#00c6ff;--verde:#25D366;--rojo:#c00;--sombra:0 4px 12px rgba(0,0,0,.12)}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(to bottom,#ccefff,#ffffff);margin-bottom:100px}
  header{background:linear-gradient(to right,var(--azul1),var(--azul2));color:#fff;text-align:center;padding:28px 16px}
  header h1{margin:0;font-size:2rem}
  header p{margin:.3rem 0 0;opacity:.95}
  .intro{background:#fff;border-radius:14px;box-shadow:var(--sombra);padding:16px 20px;margin:18px auto;max-width:820px;width:90%;text-align:center;font-size: 0.95rem;}
  .aviso{background:#ffa500;color:#fff;font-weight:700;text-align:center;padding:10px;margin:12px auto 0;max-width:980px;border-radius:10px}
  
  /* Contenedor de productos */
  #productos{display:flex;flex-wrap:wrap;gap:22px;justify-content:center;padding:22px}

  /* Tarjeta de producto */
  .card{width:260px;background:#fff;border-radius:16px;box-shadow:var(--sombra);overflow:hidden;text-align:center;transition:.25s transform,.25s box-shadow}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.16)}
  .imgwrap{position:relative;height:200px;background:#f2f6fb}
  .imgwrap img{width:100%;height:100%;object-fit:cover;opacity:0;transform:translateY(8px);transition:opacity .5s ease,transform .5s ease}
  .card.loaded .imgwrap img{opacity:1;transform:translateY(0)}
  .nombre{font-weight:600;color:#0a2a5f;margin:10px 10px 4px}
  .precio{font-weight:700;color:#333;margin:0 0 10px; font-size: 1.1rem;}
  .btn{display:inline-block;background:var(--verde);color:#fff;text-decoration:none;padding:9px 14px;border-radius:12px;margin:0 0 14px;font-weight:600;border:none;font-family:'Poppins',sans-serif;font-size:0.9rem;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  footer{background:#f7f7f7;text-align:center;color:#555;font-size:.9rem;padding:12px;margin-top:8px}

  /* Precios de Oferta */
  .precio-anterior{font-size: 0.9rem;color: #777;text-decoration: line-through;margin: -5px 0 2px;}
  .precio-oferta{font-weight: 700;color:var(--rojo);font-size: 1.15rem;margin: 0 0 10px;}

  /* Mapa y Mayorista */
  .mapa-link-wrap{margin-top:16px}
  .btn-mapa{background:var(--azul1);color:white;padding:10px 15px;border-radius:8px;text-decoration:none;font-weight:600}
  .btn-mapa:hover{background:var(--azul2)}
  .mayorista {margin-top: 12px;font-weight: 600;color: var(--azul1);}

  /* =================================================================
   * INICIO: NUEVO CSS (Spinner y Filtros)
   * ================================================================= */

  /* Estilos del Spinner de Carga */
  .spinner-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--azul1);
    font-weight: 600;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f0f0f0;
    border-top: 4px solid var(--azul1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Contenedor de Filtros */
  #filtros-categorias {
    text-align: center;
    padding: 10px 15px;
    flex-wrap: wrap; /* Para que los botones se ajusten en m√≥viles */
    display: flex; /* Oculto por defecto, JS lo mostrar√° */
    justify-content: center;
    gap: 10px;
  }
  .btn-filtro {
    background-color: #f0f0f0;
    color: #444;
    border: none;
    padding: 8px 14px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    transition: all 0.2s ease;
  }
  .btn-filtro:hover {
    background-color: #ddd;
  }
  .btn-filtro.active {
    background-color: var(--azul1);
    color: white;
  }

  /* =================================================================
   * FIN: NUEVO CSS
   * ================================================================= */

  /* --- CSS DEL CARRITO (Sin cambios) --- */
  #btn-flotante-carrito {position: fixed;bottom: 20px;right: 20px;background-color: var(--verde);color: white;padding: 12px 18px;border-radius: 50px;box-shadow: 0 4px 12px rgba(0,0,0,0.2);font-weight: 600;font-size: 1rem;cursor: pointer;z-index: 999;border: none;display: none;}
  #modal-carrito {display: none; position: fixed; z-index: 1000; left: 0;top: 0;width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);}
  .modal-contenido {background-color: #fefefe;margin: 15% auto; padding: 24px;border: 1px solid #888;border-radius: 12px;width: 90%;max-width: 500px;box-shadow: 0 5px 20px rgba(0,0,0,0.3);}
  .modal-header {display: flex;justify-content: space-between;align-items: center;border-bottom: 1px solid #eee;padding-bottom: 10px;}
  .modal-header h2 {margin: 0;color: var(--azul1);}
  .modal-cerrar {color: #aaa;font-size: 32px;font-weight: bold;cursor: pointer;}
  .modal-cerrar:hover,.modal-cerrar:focus {color: #333;}
  #cart-items {list-style: none;padding: 0;margin-top: 15px;max-height: 250px;overflow-y: auto;}
  .cart-item {display: flex;justify-content: space-between;align-items: center;padding: 8px 4px;border-bottom: 1px solid #f0f0f0;font-size: 0.95rem;}
  .cart-item span {flex-grow: 1;}
  .cart-item button {background: none;border: none;color: var(--rojo);font-size: 1.2rem;font-weight: bold;cursor: pointer;padding: 0 5px;}
  .cart-total {text-align: right;font-size: 1.3rem;font-weight: 700;margin-top: 20px;color: #333;}
  .cart-acciones {display: flex;justify-content: space-between;margin-top: 20px;}
  .btn-vaciar {background: #aaa;}
  .btn-vaciar:hover {background: #888;}
  .btn:focus,.btn-mapa:focus,#btn-flotante-carrito:focus,.modal-cerrar:focus {outline: none;box-shadow: none;}

</style>
</head>
<body>

<header>
  <h1>Distribuidora A & B</h1>
  <p>Productos de limpieza MAX Oxy con calidad y precios accesibles</p>
</header>

<div class="intro">
  üß¥ Bienvenido a Distribuidora A & B. Conoc√© nuestros productos de limpieza de calidad premium.<br>
  üìç Mercado Las Victorias, Local No. 44, Zona 5, Huehuetenango.
  
  <div class="mayorista">
    Precios especiales a clientes mayoristas
  </div>
  
  <div class="mapa-link-wrap">
    <a href="http://googleusercontent.com/maps/google.com/1" 
       class="btn-mapa" 
       target="_blank">
       üìç C√≥mo llegar
    </a>
  </div>

</div>

<div class="aviso">
  üöö Entrega GRATIS en compras mayores de Q150 ‚Äî Pedidos menores, costo de env√≠o Q15 en toda la ciudad de Huehuetenango.
</div>

<div id="filtros-categorias"></div>

<div id="productos">
  <div class="spinner-wrap">
    <div class="spinner"></div>
    <div>Cargando productos‚Ä¶</div>
  </div>
</div>
<footer>¬© Distribuidora A & B - Huehuetenango 2025</footer>

<button id="btn-flotante-carrito" onclick="mostrarCarrito()">
  üõí Carrito (0) - Q0.00
</button>
<div id="modal-carrito">
  <div class="modal-contenido">
    <div class="modal-header">
      <h2>Mi Pedido</h2>
      <span class="modal-cerrar" onclick="ocultarCarrito()">√ó</span>
    </div>
    <ul id="cart-items">
      <li>A√∫n no tienes productos.</li>
    </ul>
    <div id="cart-total" class="cart-total">
      Total: Q0.00
    </div>
    <div class="cart-acciones">
      <button class="btn btn-vaciar" onclick="vaciarCarrito()">Vaciar Carrito</button>
      <button class="btn" onclick="finalizarPedido()">Finalizar Pedido (WhatsApp)</button>
    </div>
  </div>
</div>


<script>
/* === CONFIGURACI√ìN === */
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDuTYvulCwesaBrL74caLRyCnPuBVAMWUSHzfyUelxzclArKYz0H1x6HY5gC0hL3ZPGqkJQbAxsU4D/pub?gid=0&single=true&output=csv";
const IMAGE_COL_INDEX = 3; // 0=A, 1=B, 2=C, 3=D, 4=E
const whatsapp = "50247111160";

/* VARIABLES GLOBALES Y ELEMENTOS DEL CARRITO */
let carrito = []; 
let modal, btnFlotante, cartList, cartTotalEl;
let contProductos, contFiltros; // Nuevas variables para contenedores


/* === UTILIDADES === */
function trimAll(x){ return (x||"").toString().replace(/^\s+|\s+$/g,""); }
function stripQuotes(x){ return (x||"").replace(/^"+|"+$/g,"").replace(/['‚Äú‚Äù]+/g,""); }
function extractDriveId(url){
  if(!url) return "";
  const u = stripQuotes(url).trim();
  let m = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  m = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  if(/^[a-zA-Z0-9_-]{25,}$/.test(u)) return u;
  return "";
}
function buildImageWithFallback(id, onLoadCallback){
  if(!id) return null;
  const primary   = `https://drive.google.com/uc?export=view&id=${id}`;
  const fallback1 = `https://lh3.googleusercontent.com/d/${id}`;
  const fallback2 = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
  const cb = `cb=${Date.now()}`;
  const seq = [primary, fallback1, fallback2].map(u => u + (u.includes("?") ? "&" : "?") + cb);
  const img = document.createElement("img");
  let idx = 0;
  img.onload = onLoadCallback;
  img.onerror = () => {
    idx++;
    if(idx < seq.length) {
      img.src = seq[idx];
    } else {
      img.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
    }
  };
  img.src = seq[idx];
  return img;
}
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if(inQ){
      if(ch === '"' && nx === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else { cur += ch; }
    }else{
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur = ""; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row = []; cur = ""; }
      else if(ch === '\r'){ /* skip */ }
      else { cur += ch; }
    }
  }
  if(cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* === CARGA DE PRODUCTOS === */
async function cargarProductos(){
  try{
    const res = await fetch(sheetURL, { cache: "no-store" });
    const text = await res.text();
    const matriz = parseCSV(text);
    const data = matriz.slice(1).filter(r => r && r.length);

    // Selecciona el spinner y lo elimina
    const spinner = contProductos.querySelector('.spinner-wrap');
    if (spinner) {
      spinner.remove();
    }
    
    // Para guardar las categor√≠as √∫nicas
    const categorias = new Set();

    data.forEach(r => {
      // Columnas: A=0, B=1, C=2, D=3, E=4, F=5
      const categoria = trimAll(stripQuotes(r[0]||"General")); // Columna A
      const nombre    = trimAll(stripQuotes(r[1]||""));
      const precioNormalStr  = trimAll(stripQuotes(r[2]||""));
      const precioOfertaStr  = trimAll(stripQuotes(r[5]||"")); 
      const urlRaw    = trimAll(stripQuotes(r[IMAGE_COL_INDEX]||""));
      const id        = extractDriveId(urlRaw);
      
      // A√±ade la categor√≠a al Set (autom√°ticamente maneja duplicados)
      categorias.add(categoria);

      const precioNormalNum = parseFloat(precioNormalStr);
      const precioOfertaNum = parseFloat(precioOfertaStr);
      
      if(!nombre || isNaN(precioNormalNum)) return; 

      const precioFinalNum = precioOfertaNum > 0 ? precioOfertaNum : precioNormalNum;
      
      let precioHTML = "";
      if(precioOfertaNum > 0){
        precioHTML = `
          <div class="precio-anterior">Antes: Q${precioNormalNum.toFixed(2)}</div>
          <div class="precio-oferta">OFERTA: Q${precioOfertaNum.toFixed(2)}</div>
        `;
      } else {
        precioHTML = `<div class="precio">Q${precioNormalNum.toFixed(2)}</div>`;
      }

      const card = document.createElement("div");
      card.className = "card";
      
      // =================================================================
      // NUEVO: A√±ade la categor√≠a como un "data-attribute" a la tarjeta
      card.dataset.categoria = categoria;
      // =================================================================

      const imgWrap = document.createElement("div");
      imgWrap.className = "imgwrap";

      const onImageLoaded = () => card.classList.add("loaded");
      const imgEl = buildImageWithFallback(id || urlRaw, onImageLoaded);

      if(imgEl){ imgWrap.appendChild(imgEl); }
      else{
        const ph = document.createElement("img");
        ph.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
        imgWrap.appendChild(ph);
        card.classList.add("loaded");
      }

      card.appendChild(imgWrap);
      
      card.insertAdjacentHTML("beforeend", `
        <div class="nombre">${nombre}</div>
        ${precioHTML} 
        <button class="btn" onclick="agregarAlCarrito('${nombre}', ${precioFinalNum})">
            A√±adir al carrito
        </button>
      `);

      contProductos.appendChild(card);
    });

    // Llama a la nueva funci√≥n para crear los botones de filtro
    renderizarFiltros(categorias);

    if(!contProductos.children.length){
      contProductos.innerHTML = "<p>No se encontraron productos.</p>";
    }
  }catch(e){
    console.error(e);
    contProductos.innerHTML = "<p style='color:#c00'>No se pudieron cargar los productos.</p>";
  }
}

/* =================================================================
 * INICIO: NUEVAS FUNCIONES (FILTROS)
 * ================================================================= */

// Crea los botones de filtro en el HTML
function renderizarFiltros(categoriasSet) {
  // Convierte el Set a un Array y lo ordena alfab√©ticamente
  const categorias = [...categoriasSet].sort();

  // Bot√≥n "Ver Todos"
  const btnTodos = document.createElement('button');
  btnTodos.className = 'btn-filtro active'; // Activo por defecto
  btnTodos.innerText = 'Ver Todos';
  btnTodos.onclick = () => filtrarProductos('Todos');
  contFiltros.appendChild(btnTodos);

  // Botones para cada categor√≠a
  categorias.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'btn-filtro';
    btn.innerText = cat;
    // Usamos comillas dentro de la funci√≥n para pasar el string
    btn.onclick = () => filtrarProductos(cat);
    contFiltros.appendChild(btn);
  });
}

// Muestra/Oculta productos seg√∫n la categor√≠a seleccionada
function filtrarProductos(categoria) {
  // 1. Maneja la clase "active" en los botones
  const botones = contFiltros.querySelectorAll('.btn-filtro');
  botones.forEach(btn => {
    if (btn.innerText === categoria) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // 2. Muestra/Oculta las tarjetas de productos
  const cards = contProductos.querySelectorAll('.card');
  cards.forEach(card => {
    if (categoria === 'Todos' || card.dataset.categoria === categoria) {
      card.style.display = 'block'; // Muestra la tarjeta
    } else {
      card.style.display = 'none'; // Oculta la tarjeta
    }
  });
}

/* =================================================================
 * FIN: NUEVAS FUNCIONES (FILTROS)
 * ================================================================= */


/* --- FUNCIONES DEL CARRITO (Sin cambios) --- */
function mostrarCarrito() { modal.style.display = "block"; }
function ocultarCarrito() { modal.style.display = "none"; }

function agregarAlCarrito(nombre, precio) {
  const itemExistente = carrito.find(item => item.nombre === nombre);
  if (itemExistente) {
    itemExistente.cantidad++; 
  } else {
    carrito.push({ nombre: nombre, precio: precio, cantidad: 1 });
  }
  renderizarCarrito();
}

function eliminarDelCarrito(index) {
  carrito.splice(index, 1); 
  renderizarCarrito();
}

function vaciarCarrito() {
  carrito = [];
  renderizarCarrito();
  ocultarCarrito();
}

function renderizarCarrito() {
  let total = 0;
  let totalItems = 0;
  
  if (carrito.length === 0) {
    cartList.innerHTML = "<li>A√∫n no tienes productos.</li>";
  } else {
    cartList.innerHTML = ""; 
    carrito.forEach((item, index) => {
      const subtotal = item.precio * item.cantidad;
      total += subtotal;
      totalItems += item.cantidad;
      const li = document.createElement("li");
      li.className = "cart-item";
      li.innerHTML = `
        <span>${item.cantidad}x ${item.nombre} (Q${subtotal.toFixed(2)})</span>
        <button onclick="eliminarDelCarrito(${index})">√ó</button>
      `;
      cartList.appendChild(li);
    });
  }
  
  cartTotalEl.innerText = `Total: Q${total.toFixed(2)}`;
  
  if (totalItems > 0) {
    btnFlotante.innerHTML = `üõí Carrito (${totalItems}) - Q${total.toFixed(2)}`;
    btnFlotante.style.display = "block";
  } else {
    btnFlotante.style.display = "none";
  }
}

function finalizarPedido() {
  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o.");
    return;
  }
  let mensaje = "Hola, quiero pedir lo siguiente:\n\n";
  let total = 0;
  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    mensaje += `${item.cantidad}x ${item.nombre} - Q${subtotal.toFixed(2)}\n`;
    total += subtotal;
  });
  mensaje += `\n*Total a pagar: Q${total.toFixed(2)}*`;
  const url = `https://wa.me/${whatsapp}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
}


// Evento que se dispara cuando el HTML est√° listo
document.addEventListener("DOMContentLoaded", () => {
  // Asigna las variables globales a los elementos del DOM
  modal = document.getElementById("modal-carrito");
  btnFlotante = document.getElementById("btn-flotante-carrito");
  cartList = document.getElementById("cart-items");
  cartTotalEl = document.getElementById("cart-total");
  
  // =================================================================
  // NUEVO: Asigna los contenedores principales
  contProductos = document.getElementById("productos");
  contFiltros = document.getElementById("filtros-categorias");
  // =================================================================

  window.onclick = function(event) {
    if (event.target == modal) {
      ocultarCarrito();
    }
  }

  cargarProductos();
});
</script>
</body>
</html>
