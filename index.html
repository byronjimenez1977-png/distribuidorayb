<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Distribuidora A & B</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--azul1:#007bff;--azul2:#00c6ff;--verde:#25D366;--sombra:0 4px 12px rgba(0,0,0,.12)}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(to bottom,#ccefff,#ffffff)}
  header{background:linear-gradient(to right,var(--azul1),var(--azul2));color:#fff;text-align:center;padding:28px 16px}
  header h1{margin:0;font-size:2rem}
  header p{margin:.3rem 0 0;opacity:.95}
  .intro{background:#fff;border-radius:14px;box-shadow:var(--sombra);padding:16px 20px;margin:18px auto;max-width:820px;width:90%;text-align:center}
  .aviso{background:#ffa500;color:#fff;font-weight:700;text-align:center;padding:10px;margin:12px auto 0;max-width:980px;border-radius:10px}
  #productos{display:flex;flex-wrap:wrap;gap:22px;justify-content:center;padding:22px}
  .card{width:260px;background:#fff;border-radius:16px;box-shadow:var(--sombra);overflow:hidden;text-align:center;transition:.25s transform,.25s box-shadow}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.16)}
  .imgwrap{position:relative;height:200px;background:#f2f6fb}
  .imgwrap img{width:100%;height:100%;object-fit:cover;opacity:0;transform:translateY(8px);transition:opacity .5s ease,transform .5s ease}
  .card.loaded .imgwrap img{opacity:1;transform:translateY(0)}
  .nombre{font-weight:600;color:#0a2a5f;margin:10px 10px 4px}
  .precio{font-weight:700;color:#333;margin:0 0 10px}
  .btn{display:inline-block;background:var(--verde);color:#fff;text-decoration:none;padding:9px 14px;border-radius:12px;margin:0 0 14px;font-weight:600}
  .btn:hover{filter:brightness(.95)}
  footer{background:#f7f7f7;text-align:center;color:#555;font-size:.9rem;padding:12px;margin-top:8px}
</style>
</head>
<body>

<header>
  <h1>Distribuidora A & B</h1>
  <p>Productos de limpieza MAX Oxy con calidad y precios accesibles</p>
</header>

<div class="intro">
  üß¥ Bienvenido a Distribuidora A & B. Conoc√© nuestros productos de limpieza de calidad premium.<br>
  üìç Mercado Las Victorias, Local No. 44, Zona 5, Huehuetenango.
</div>

<div class="aviso">
  üöö Entrega GRATIS en compras mayores de Q150 ‚Äî Pedidos menores, costo de env√≠o Q15 en toda la ciudad de Huehuetenango.
</div>

<div id="productos">Cargando productos‚Ä¶</div>

<footer>¬© Distribuidora A & B - Huehuetenango 2025</footer>

<script>
/* === CONFIGURACI√ìN === */
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDuTYvulCwesaBrL74caLRyCnPuBVAMWUSHzfyUelxzclArKYz0H1x6HY5gC0hL3ZPGqkJQbAxsU4D/pub?gid=0&single=true&output=csv";
/* Si en tu hoja la imagen est√° en columna D usa 3; si est√° en columna E (Imagen limpia), usa 4 */
const IMAGE_COL_INDEX = 3; // 0=A, 1=B, 2=C, 3=D, 4=E
const whatsapp = "50247111160";

/* === UTILIDADES PARA LIMPIAR / NORMALIZAR === */
function trimAll(x){ return (x||"").toString().replace(/^\s+|\s+$/g,""); }
function stripQuotes(x){ return (x||"").replace(/^"+|"+$/g,"").replace(/['‚Äú‚Äù]+/g,""); }

/* Extrae ID desde cualquier formato de Drive */
function extractDriveId(url){
  if(!url) return "";
  const u = stripQuotes(url).trim();
  // uc?id=ID
  let m = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  // /file/d/ID/
  m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  // /d/ID (lh3, etc)
  m = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  // texto plano que ya es ID
  if(/^[a-zA-Z0-9_-]{25,}$/.test(u)) return u;
  return "";
}

/* * =================================================================
 * INICIO DE LA CORRECCI√ìN 1: Funci√≥n buildImageWithFallback
 * Ahora acepta 'onLoadCallback'
 * =================================================================
 */
function buildImageWithFallback(id, onLoadCallback){
  if(!id) return null;
  const primary   = `https://drive.google.com/uc?export=view&id=${id}`;
  const fallback1 = `https://lh3.googleusercontent.com/d/${id}`; // alternativa estable
  const fallback2 = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`; // miniatura grande

  // Cache-buster para evitar cach√© vieja del navegador/CDN
  const cb = `cb=${Date.now()}`;
  const seq = [primary, fallback1, fallback2].map(u => u + (u.includes("?") ? "&" : "?") + cb);

  // Creamos el elemento <img> con encadenamiento de fallbacks
  const img = document.createElement("img");
  let idx = 0;

  // **** ¬°LA CORRECCI√ìN EST√Å AQU√ç! ****
  // Asignamos los listeners ANTES de poner el src
  img.onload = onLoadCallback; // Asignamos el callback que recibimos

  img.onerror = () => {
    idx++;
    if(idx < seq.length) {
      img.src = seq[idx]; // Intenta con el siguiente fallback
    } else {
      // Si todo falla, usa el placeholder.
      // Esto disparar√° 'onload' (si placeholder.com funciona)
      // y mostrar√° el texto de error.
      img.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
    }
  };
  
  // Asignamos el src AL FINAL, despu√©s de que los listeners est√©n listos
  img.src = seq[idx];
  return img;
}
/* * =================================================================
 * FIN DE LA CORRECCI√ìN 1
 * =================================================================
 */


/* Parser CSV simple (maneja comillas) */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if(inQ){
      if(ch === '"' && nx === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else { cur += ch; }
    }else{
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur = ""; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row = []; cur = ""; }
      else if(ch === '\r'){ /* skip */ }
      else { cur += ch; }
    }
  }
  if(cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* Render principal */
async function cargarProductos(){
  const cont = document.getElementById("productos");
  try{
    const res = await fetch(sheetURL, { cache: "no-store" });
    const text = await res.text();
    const matriz = parseCSV(text);
    // quitar encabezado si lo hay (primera fila con t√≠tulos)
    const data = matriz.slice(1).filter(r => r && r.length);

    cont.innerHTML = "";
    data.forEach(r => {
      const categoria = trimAll(stripQuotes(r[0]||""));
      const nombre    = trimAll(stripQuotes(r[1]||""));
      const precio    = trimAll(stripQuotes(r[2]||""));
      const urlRaw    = trimAll(stripQuotes(r[IMAGE_COL_INDEX]||""));
      const id        = extractDriveId(urlRaw);

      if(!nombre || !precio) return; // saltar filas vac√≠as

      const card = document.createElement("div");
      card.className = "card";
      const imgWrap = document.createElement("div");
      imgWrap.className = "imgwrap";

      /* * =================================================================
       * INICIO DE LA CORRECCI√ìN 2: C√≥mo se llama a la funci√≥n
       * =================================================================
       */
      
      // 1. Define la funci√≥n de callback primero
      const onImageLoaded = () => {
        card.classList.add("loaded");
      };

      // 2. Pasa el ID y el callback a la funci√≥n
      const imgEl = buildImageWithFallback(id || urlRaw, onImageLoaded);

      if(imgEl){
        // 3. Simplemente a√±ade la imagen. El 'onload' ya fue asignado dentro de la funci√≥n.
        imgWrap.appendChild(imgEl);
      }else{
        // si no logramos ID ni URL v√°lida, placeholder
        const ph = document.createElement("img");
        ph.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
        imgWrap.appendChild(ph);
        card.classList.add("loaded"); // Carga la tarjeta de todos modos para ver el placeholder
      }
      /* * =================================================================
       * FIN DE LA CORRECCI√ìN 2
       * =================================================================
       */

      card.appendChild(imgWrap);
      card.insertAdjacentHTML("beforeend", `
        <div class="nombre">${nombre}</div>
        <div class="precio">Q${precio}</div>
        <a class="btn" target="_blank"
            href="https://wa.me/${whatsapp}?text=${encodeURIComponent(`Hola, quiero pedir ${nombre} (Q${precio})`)}">
            Pedir por WhatsApp
        </a>
      `);

      cont.appendChild(card);
    });

    if(!cont.children.length){
      cont.innerHTML = "<p>No se encontraron productos. Revis√° que la hoja tenga filas y que el enlace sea CSV.</p>";
    }
  }catch(e){
    console.error(e);
    cont.innerHTML = "<p style='color:#c00'>No se pudieron cargar los productos. Verific√° el enlace CSV p√∫blico.</p>";
  }
}

document.addEventListener("DOMContentLoaded", cargarProductos);
</script>
</body>
</html>
