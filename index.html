<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Distribuidora A & B</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<meta name="theme-color" content="#007bff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dist. A&B">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{--azul1:#007bff;--azul2:#00c6ff;--verde:#25D366;--rojo:#c00;--sombra:0 4px 12px rgba(0,0,0,.12)}
  *{box-sizing:border-box}
  
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background: #ccefff; /* Color s√≥lido de fallback */
    margin-bottom:100px;
  }

  .burbujas-fondo {
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: 0; 
    background: linear-gradient(to bottom,#ccefff,#ffffff);
  }

  .burbujas-fondo span {
    position: absolute;
    bottom: -100px; 
    width: 40px;
    height: 40px;
    background-color: rgba(255, 255, 255, 0.18); 
    border-radius: 50%;
    animation: animarBurbujas 20s linear infinite;
    opacity: 0.8;
    will-change: transform, opacity;
  }

  @keyframes animarBurbujas {
    0% { transform: translateY(0); opacity: 0.7; }
    100% { transform: translateY(-120vh); opacity: 0; }
  }

  .burbujas-fondo span:nth-child(1) { left: 10%; animation-duration: 25s; animation-delay: 2s; width: 20px; height: 20px; }
  .burbujas-fondo span:nth-child(2) { left: 80%; animation-duration: 18s; animation-delay: 0s; width: 50px; height: 50px; }
  .burbujas-fondo span:nth-child(3) { left: 30%; animation-duration: 22s; animation-delay: 5s; width: 35px; height: 35px; }
  .burbujas-fondo span:nth-child(4) { left: 50%; animation-duration: 20s; animation-delay: 7s; width: 15px; height: 15px; }
  .burbujas-fondo span:nth-child(5) { left: 65%; animation-duration: 28s; animation-delay: 1s; width: 45px; height: 45px; }
  .burbujas-fondo span:nth-child(6) { left: 90%; animation-duration: 15s; animation-delay: 4s; width: 25px; height: 25px; }
  .burbujas-fondo span:nth-child(7) { left: 20%; animation-duration: 23s; animation-delay: 8s; width: 30px; height: 30px; }
  .burbujas-fondo span:nth-child(8) { left: 45%; animation-duration: 19s; animation-delay: 3s; width: 40px; height: 40px; }
  
  /* --- Contenido Principal --- */
  header, .intro, .aviso, #filtros-categorias, #productos, footer {
    position: relative;
    z-index: 2; 
  }

  header{background:linear-gradient(to right,var(--azul1),var(--azul2));color:#fff;text-align:center;padding:28px 16px}
  header h1{margin:0;font-size:2rem}
  header p{margin:.3rem 0 0;opacity:.95}
  .intro{background:#fff;border-radius:14px;box-shadow:var(--sombra);padding:16px 20px;margin:18px auto;max-width:820px;width:90%;text-align:center;font-size: 0.95rem;}
  .aviso{background:#ffa500;color:#fff;font-weight:700;text-align:center;padding:10px;margin:12px auto 0;max-width:980px;border-radius:10px}
  
  #productos{display:flex;flex-wrap:wrap;gap:22px;justify-content:center;padding:22px}
  .card{width:260px;background:#fff;border-radius:16px;box-shadow:var(--sombra);overflow:hidden;text-align:center;transition:.25s transform,.25s box-shadow}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.16)}
  .imgwrap{position:relative;height:200px;background:#f2f6fb}
  .imgwrap img{width:100%;height:100%;object-fit:cover;opacity:0;transform:translateY(8px);transition:opacity .5s ease,transform .5s ease}
  .card.loaded .imgwrap img{opacity:1;transform:translateY(0)}
  .nombre{font-weight:600;color:#0a2a5f;margin:10px 10px 4px}
  .precio{font-weight:700;color:#333;margin:0 0 10px; font-size: 1.1rem;}
  .btn{display:inline-block;background:var(--verde);color:#fff;text-decoration:none;padding:9px 14px;border-radius:12px;margin:0 0 14px;font-weight:600;border:none;font-family:'Poppins',sans-serif;font-size:0.9rem;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  footer{background:#f7f7f7;text-align:center;color:#555;font-size:.9rem;padding:12px;margin-top:8px}

  .precio-anterior{font-size: 0.9rem;color: #777;text-decoration: line-through;margin: -5px 0 2px;}
  .precio-oferta{font-weight: 700;color:var(--rojo);font-size: 1.15rem;margin: 0 0 10px;}

  .mapa-link-wrap{margin-top:16px}
  .btn-mapa{background:var(--azul1);color:white;padding:10px 15px;border-radius:8px;text-decoration:none;font-weight:600}
  .btn-mapa:hover{background:var(--azul2)}
  .mayorista {margin-top: 12px;font-weight: 600;color: var(--azul1);}

  .spinner-wrap {display: flex;flex-direction: column;align-items: center;justify-content: center;padding: 40px;color: var(--azul1);font-weight: 600;}
  .spinner {width: 40px;height: 40px;border: 4px solid #f0f0f0;border-top: 4px solid var(--azul1);border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 10px;}
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #filtros-categorias {text-align: center;padding: 10px 15px;flex-wrap: wrap;display: flex;justify-content: center;gap: 10px;}
  .btn-filtro {background-color: #f0f0f0;color: #444;border: none;padding: 8px 14px;border-radius: 20px;cursor: pointer;font-weight: 600;font-family: 'Poppins', sans-serif;transition: all 0.2s ease;}
  .btn-filtro:hover {background-color: #ddd;}
  .btn-filtro.active {background-color: var(--azul1);color: white;}

  /* --- CSS DEL CARRITO --- */
  #btn-flotante-carrito {position: fixed;bottom: 20px;right: 20px;background-color: var(--verde);color: white;padding: 12px 18px;border-radius: 50px;box-shadow: 0 4px 12px rgba(0,0,0,0.2);font-weight: 600;font-size: 1rem;cursor: pointer;z-index: 999;border: none;display: none;}
  #modal-carrito {display: none; position: fixed; z-index: 1000; left: 0;top: 0;width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);}
  .modal-contenido {background-color: #fefefe;margin: 15% auto; padding: 24px;border: 1px solid #888;border-radius: 12px;width: 90%;max-width: 500px;box-shadow: 0 5px 20px rgba(0,0,0,0.3);}
  .modal-header {display: flex;justify-content: space-between;align-items: center;border-bottom: 1px solid #eee;padding-bottom: 10px;}
  .modal-header h2 {margin: 0;color: var(--azul1);}
  .modal-cerrar {color: #aaa;font-size: 32px;font-weight: bold;cursor: pointer;}
  .modal-cerrar:hover,.modal-cerrar:focus {color: #333;}
  #cart-items {list-style: none;padding: 0;margin-top: 15px;max-height: 250px;overflow-y: auto;}

  /* =================================================================
   * INICIO: CAMBIOS CSS DEL CARRITO
   * ================================================================= */
  .cart-item {
    display: flex;
    align-items: center; /* Centra verticalmente */
    gap: 10px; /* Espacio entre imagen y texto */
    padding: 8px 4px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.95rem;
  }
  
  .cart-item-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 8px;
    background: #f0f0f0; /* Color mientras carga */
    flex-shrink: 0; /* Evita que la imagen se encoja */
  }
  
  .cart-item-details {
    flex-grow: 1; /* Ocupa el espacio restante */
    line-height: 1.3;
  }
  
  .cart-item-details small {
    font-weight: 600;
    color: #333;
  }

  .cart-item button {
    background: none;
    border: none;
    color: var(--rojo);
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    padding: 0 5px;
    flex-shrink: 0; /* Evita que el bot√≥n se encoja */
  }
  /* =================================================================
   * FIN: CAMBIOS CSS DEL CARRITO
   * ================================================================= */

  .cart-total {text-align: right;font-size: 1.3rem;font-weight: 700;margin-top: 20px;color: #333;}
  .cart-acciones {display: flex;justify-content: space-between;margin-top: 20px;}
  .btn-vaciar {background: #aaa;}
  .btn-vaciar:hover {background: #888;}
  .btn:focus,.btn-mapa:focus,#btn-flotante-carrito:focus,.modal-cerrar:focus {outline: none;box-shadow: none;}

</style>
</head>
<body>

<div class="burbujas-fondo">
  <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
</div>

<header>
  <h1>Distribuidora A & B</h1>
  <p>Productos de limpieza MAX Oxy con calidad y precios accesibles</p>
</header>

<div class="intro">
  üß¥ Bienvenido a Distribuidora A & B. Conoc√© nuestros productos de limpieza de calidad premium.<br>
  üìç Mercado Las Victorias, Local No. 44, Zona 5, Huehuetenango.
  <div class="mayorista">Precios especiales a clientes mayoristas</div>
  <div class="mapa-link-wrap">
    <a href="https://maps.app.goo.gl/t32iQBNhpJPLCS4r8?g_st=aw"
       class="btn-mapa"
       target="_blank"
       rel="noopener noreferrer">
      üìç C√≥mo llegar
    </a>
  </div>
</div>

<div class="aviso">
  üöö Entrega GRATIS en compras mayores de Q250 ‚Äî Pedidos menores, costo de env√≠o Q15 en toda la ciudad de Huehuetenango.
</div>

<div id="filtros-categorias"></div>

<div id="productos">
  <div class="spinner-wrap">
    <div class="spinner"></div>
    <div>Cargando productos‚Ä¶</div>
  </div>
</div>

<footer>¬© Distribuidora A & B - Huehuetenango 2025</footer>

<button id="btn-flotante-carrito" onclick="mostrarCarrito()">üõí Carrito (0) - Q0.00</button>
<div id="modal-carrito">
  <div class="modal-contenido">
    <div class="modal-header">
      <h2>Mi Pedido</h2>
      <span class="modal-cerrar" onclick="ocultarCarrito()">√ó</span>
    </div>
    <ul id="cart-items"><li>A√∫n no tienes productos.</li></ul>
    <div id="cart-total" class="cart-total">Total: Q0.00</div>
    <div class="cart-acciones">
      <button class="btn btn-vaciar" onclick="vaciarCarrito()">Vaciar Carrito</button>
      <button class="btn" onclick="finalizarPedido()">Finalizar Pedido (WhatsApp)</button>
    </div>
  </div>
</div>


<script>
/* === CONFIGURACI√ìN === */
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDuTYvulCwesaBrL74caLRyCnPuBVAMWUSHzfyUelxzclArKYz0H1x6HY5gC0hL3ZPGqkJQbAxsU4D/pub?gid=0&single=true&output=csv";
const IMAGE_COL_INDEX = 3; // 0=A, 1=B, 2=C, 3=D, 4=E
const whatsapp = "50247111160";
const CACHE_DURACION_MINUTOS = 30;

/* VARIABLES GLOBALES Y ELEMENTOS DEL DOM */
let carrito = []; 
let modal, btnFlotante, cartList, cartTotalEl;
let contProductos, contFiltros;


/* === UTILIDADES === */
function trimAll(x){ return (x || "").toString().replace(/^\s+|\s+$/g,""); }
function stripQuotes(x){ return (x || "").replace(/^"+|"+$/g,"").replace(/['‚Äú‚Äù]+/g,""); }

function extractDriveId(url){
  if(!url) return "";
  const u = stripQuotes(url).trim();
  let m = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  m = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  if(/^[a-zA-Z0-9_-]{25,}$/.test(u)) return u;
  return "";
}

function buildImageWithFallback(id, onLoadCallback){
  if(!id) return null;
  const primary   = `https://drive.google.com/uc?export=view&id=${id}`;
  const fallback1 = `https://lh3.googleusercontent.com/d/${id}`;
  const fallback2 = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
  const cb = `cb=${Date.now()}`;
  const seq = [primary, fallback1, fallback2].map(u => u + (u.includes("?") ? "&" : "?") + cb);
  
  const img = document.createElement("img");
  let idx = 0;
  
  img.onload = onLoadCallback;
  img.onerror = () => {
    idx++;
    if(idx < seq.length) {
      img.src = seq[idx];
    } else {
      img.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
    }
  };
  
  img.loading = "lazy";
  img.src = seq[idx];
  return img;
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if(inQ){
      if(ch === '"' && nx === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else { cur += ch; }
    }else{
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur = ""; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row = []; cur = ""; }
      else if(ch === '\r'){ /* skip */ }
      else { cur += ch; }
    }
  }
  if(cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* === L√ìGICA DE CACH√â Y CARGA === */

async function cargarProductosDesdeSheet(){
  console.log("Cargando desde Google Sheet (Lento)...");
  try{
    const res = await fetch(sheetURL, { cache: "no-store" });
    const text = await res.text();
    const matriz = parseCSV(text);
    const data = matriz.slice(1).filter(r => r && r.length);
    
    const cacheData = {
      timestamp: Date.now(),
      productos: data
    };
    localStorage.setItem('productosCache', JSON.stringify(cacheData));
    
    renderizarPagina(data);

  } catch(e) {
    console.error(e);
    contProductos.innerHTML = "<p style='color:#c00'>No se pudieron cargar los productos.</p>";
  }
}

// Dibuja la p√°gina usando los datos
function renderizarPagina(data) {
  const spinner = contProductos.querySelector('.spinner-wrap');
  if (spinner) {
    spinner.remove();
  }
  
  const categorias = new Set();
  data.forEach(r => {
    const categoria = trimAll(stripQuotes(r[0]||"General")); 
    const nombre    = trimAll(stripQuotes(r[1]||""));
    const precioNormalStr  = trimAll(stripQuotes(r[2]||""));
    const precioOfertaStr  = trimAll(stripQuotes(r[5]||"")); 
    const urlRaw    = trimAll(stripQuotes(r[IMAGE_COL_INDEX]||""));
    
    // =================================================================
    // CAMBIO JS 1: Capturamos el ID de la imagen aqu√≠
    // =================================================================
    const id        = extractDriveId(urlRaw);
    
    categorias.add(categoria);
    const precioNormalNum = parseFloat(precioNormalStr);
    const precioOfertaNum = parseFloat(precioOfertaStr);
    if(!nombre || isNaN(precioNormalNum)) return; 

    const precioFinalNum = precioOfertaNum > 0 ? precioOfertaNum : precioNormalNum;
    
    let precioHTML = "";
    if(precioOfertaNum > 0){
      precioHTML = `
        <div class="precio-anterior">Antes: Q${precioNormalNum.toFixed(2)}</div>
        <div class="precio-oferta">OFERTA: Q${precioOfertaNum.toFixed(2)}</div>
      `;
    } else {
      precioHTML = `<div class="precio">Q${precioNormalNum.toFixed(2)}</div>`;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.categoria = categoria;

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgwrap";
    const onImageLoaded = () => card.classList.add("loaded");
    const imgEl = buildImageWithFallback(id || urlRaw, onImageLoaded); // Usamos el ID

    if(imgEl){ imgWrap.appendChild(imgEl); }
    else{
      const ph = document.createElement("img");
      ph.src = "https://via.placeholder.com/640x400?text=Imagen+no+disponible";
      imgWrap.appendChild(ph);
      card.classList.add("loaded");
    }

    card.appendChild(imgWrap);
    
    // =================================================================
    // CAMBIO JS 2: Pasamos el 'id' al bot√≥n de a√±adir
    // =================================================================
    card.insertAdjacentHTML("beforeend", `
      <div class="nombre">${nombre}</div>
      ${precioHTML} 
      <button class="btn" onclick="agregarAlCarrito('${nombre}', ${precioFinalNum}, '${id}')">
          A√±adir al carrito
      </button>
    `);
    contProductos.appendChild(card);
  });

  renderizarFiltros(categorias);

  if(!contProductos.children.length){
    contProductos.innerHTML = "<p>No se encontraron productos.</p>";
  }
}

// Revisa el cach√© al cargar la p√°gina
function iniciarCarga() {
  const cacheJSON = localStorage.getItem('productosCache');
  if (cacheJSON) {
    const cache = JSON.parse(cacheJSON);
    const ahora = Date.now();
    const tiempoPasado = (ahora - cache.timestamp) / (1000 * 60); 
    
    if (tiempoPasado < CACHE_DURACION_MINUTOS) {
      console.log("Cargando desde Cach√© (R√°pido)...");
      renderizarPagina(cache.productos);
      return;
    }
  }
  
  cargarProductosDesdeSheet();
}


/* === FUNCIONES DE FILTROS === */
function renderizarFiltros(categoriasSet) {
  contFiltros.innerHTML = ""; 
  const categorias = [...categoriasSet].sort();
  const btnTodos = document.createElement('button');
  btnTodos.className = 'btn-filtro active'; 
  btnTodos.innerText = 'Ver Todos';
  btnTodos.onclick = () => filtrarProductos('Todos');
  contFiltros.appendChild(btnTodos);

  categorias.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'btn-filtro';
    btn.innerText = cat;
    btn.onclick = () => filtrarProductos(cat);
    contFiltros.appendChild(btn);
  });
}
function filtrarProductos(categoria) {
  const botones = contFiltros.querySelectorAll('.btn-filtro');
  botones.forEach(btn => {
    if (btn.innerText === categoria) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  const cards = contProductos.querySelectorAll('.card');
  cards.forEach(card => {
    if (categoria === 'Todos' || card.dataset.categoria === categoria) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

/* =================================================================
 * INICIO: CAMBIOS EN FUNCIONES DEL CARRITO
 * ================================================================= */

function mostrarCarrito() { modal.style.display = "block"; }
function ocultarCarrito() { modal.style.display = "none"; }

// CAMBIO JS 3: La funci√≥n ahora acepta 'imagenId'
function agregarAlCarrito(nombre, precio, imagenId) {
  const itemExistente = carrito.find(item => item.nombre === nombre);
  
  if (itemExistente) {
    itemExistente.cantidad++; 
  } else {
    // Lo a√±adimos al objeto del carrito
    carrito.push({
      nombre: nombre,
      precio: precio,
      cantidad: 1,
      imagenId: imagenId // <-- NUEVA PROPIEDAD
    });
  }
  renderizarCarrito();
}

function eliminarDelCarrito(index) {
  carrito.splice(index, 1); 
  renderizarCarrito();
}
function vaciarCarrito() {
  carrito = [];
  renderizarCarrito();
  ocultarCarrito();
}

// CAMBIO JS 4: Renderizar el carrito con la imagen
function renderizarCarrito() {
  let total = 0;
  let totalItems = 0;
  
  if (carrito.length === 0) {
    cartList.innerHTML = "<li>A√∫n no tienes productos.</li>";
  } else {
    cartList.innerHTML = ""; 
    carrito.forEach((item, index) => {
      const subtotal = item.precio * item.cantidad;
      total += subtotal;
      totalItems += item.cantidad;
      
      // Creamos la URL de la miniatura de Google Drive
      let thumbUrl = "https://via.placeholder.com/100x100?text=A&B"; // Placeholder
      if (item.imagenId) {
        thumbUrl = `https://drive.google.com/thumbnail?id=${item.imagenId}&sz=w100`;
      }
      
      const li = document.createElement("li");
      li.className = "cart-item";
      
      // Nuevo HTML para el item del carrito
      li.innerHTML = `
        <img src="${thumbUrl}" class="cart-item-img" alt="${item.nombre}" loading="lazy">
        <div class="cart-item-details">
          ${item.cantidad}x ${item.nombre}
          <br>
          <small>Q${subtotal.toFixed(2)}</small>
        </div>
        <button onclick="eliminarDelCarrito(${index})">√ó</button>
      `;
      cartList.appendChild(li);
    });
  }
  
  cartTotalEl.innerText = `Total: Q${total.toFixed(2)}`;
  
  if (totalItems > 0) {
    btnFlotante.innerHTML = `üõí Carrito (${totalItems}) - Q${total.toFixed(2)}`;
    btnFlotante.style.display = "block";
  } else {
    btnFlotante.style.display = "none";
  }
}

function finalizarPedido() {
  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o.");
    return;
  }
  let mensaje = "Hola, quiero pedir lo siguiente:\n\n";
  let total = 0;
  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    mensaje += `${item.cantidad}x ${item.nombre} - Q${subtotal.toFixed(2)}\n`;
    total += subtotal;
  });
  mensaje += `\n*Total a pagar: Q${total.toFixed(2)}*`;
  const url = `https://wa.me/${whatsapp}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
}
/* =================================================================
 * FIN: CAMBIOS EN FUNCIONES DEL CARRITO
 * ================================================================= */


/* === INICIALIZACI√ìN === */
document.addEventListener("DOMContentLoaded", () => {
  modal = document.getElementById("modal-carrito");
  btnFlotante = document.getElementById("btn-flotante-carrito");
  cartList = document.getElementById("cart-items");
  cartTotalEl = document.getElementById("cart-total");
  contProductos = document.getElementById("productos");
  contFiltros = document.getElementById("filtros-categorias");

  window.onclick = function(event) {
    if (event.target == modal) {
      ocultarCarrito();
    }
  }

  iniciarCarga();
});
</script>
</body>
</html>
